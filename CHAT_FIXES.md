# Исправления чата

## Проблемы, которые были исправлены:

### 1. Основная проблема с отправкой сообщений
**Проблема**: Сообщения не отображались в реальном времени и приходили только после обновления страницы.

**Причина**: Неправильная структура данных сообщений и некорректная фильтрация в Firestore.

**Решение**: 
- Добавлено поле `chatId` для уникальной идентификации чата между двумя пользователями
- Изменена логика фильтрации с поля `user` на `chatId`
- Добавлено поле `receiver` для указания получателя

### 2. Проблема с отображением сообщений
**Проблема**: Сообщения отображались неправильно (свои сообщения показывались как чужие).

**Решение**:
- Улучшена логика определения отправителя сообщения
- Добавлена переменная `isOwnMessage` для корректного отображения

### 3. Улучшения UX
**Добавлено**:
- Индикатор загрузки при отправке сообщения
- Блокировка интерфейса во время отправки
- Улучшенная автопрокрутка к новым сообщениям
- Обработка ошибок при отправке файлов

## Структура сообщения в Firestore:

```javascript
{
  sender: "имя_отправителя",
  receiver: "имя_получателя", 
  text: "текст_сообщения",
  fileUrl: "url_файла_или_null",
  time: "2024-01-01T12:00:00.000Z",
  status: "отправлено",
  avatar: "url_аватара",
  chatId: "user1_user2" // уникальный ID чата
}
```

## Функция создания chatId:

```javascript
const getChatId = (user1, user2) => {
  const users = [user1, user2].sort();
  return `${users[0]}_${users[1]}`;
};
```

## Запрос к Firestore:

```javascript
const q = query(
  collection(db, "messages"),
  where("chatId", "==", chatId),
  orderBy("time")
);
```

## Рекомендации для Firestore:

Для корректной работы запросов убедитесь, что в Firestore создан составной индекс:
- Коллекция: `messages`
- Поля: `chatId` (Ascending), `time` (Ascending) 